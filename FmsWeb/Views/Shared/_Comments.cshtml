<script src="@Url.Content("~/Scripts/tiny_mce/tiny_mce.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.simplemodal.js")" type="text/javascript"></script>
<script type="text/javascript">
    tinyMCE.init({
        mode: "exact",
        elements: "CommentText1",
        theme: "advanced",
        plugins: "style,iespell,searchreplace,contextmenu,paste,html",

        //
        //  Theme options #1
        //
        theme_advanced_buttons1: "bold,italic,underline,forecolor,backcolor,|,formatselect,fontselect,fontsizeselect,|,cut,copy,paste,pastetext,pasteword,|,link,unlink,code",
        theme_advanced_buttons2: "justifyleft,justifycenter,justifyright,justifyfull,|,bullist,numlist,,,,,,,,,,,,,",
        theme_advanced_buttons3: "",
        theme_advanced_toolbar_location: "top",
        theme_advanced_toolbar_align: "left",
        theme_advanced_resizing: true,
        readonly: false
    });

    function DisplayCommentSection() {
        var userCommentList = $('#UserCommentList');
        userCommentList.show("slow");

        GetComments();
    }

    function AddComment() {
        var url = "/FMS/AddComment/?transactionId=" + GlobalTransactionId;
        var val = tinyMCE.get('CommentText').getContent();
        if (val != '') {
            $.post(url, { comment: val }, function () {

            }).complete(
                function () {
                    GetComments();
                    tinyMCE.get('CommentText').setContent("");
                });
        }
        $.modal.close();
    }

    function EditComment() {
        var commentID = $('#CommentID').val();
        var url = "/FMS/EditComment/?transactionId=" + GlobalTransactionId + "&commentID=" + commentID;
        var val = tinyMCE.get('CommentText').getContent();
        $.post(url, { comment: val }, function () {

        }).complete(
            function () {
                GetComments();
                tinyMCE.get('CommentText').setContent("");
                $.modal.close();
            });
    }

    function DeleteComment() {
        var commentID = $('#CommentID').val();
        var retV = confirm("Are you sure to delete this comment?");
        if (retV == true) {
            var url = "/FMS/DeleteComment/?transactionId=" + GlobalTransactionId + "&commentID=" + commentID;
            $.post(url, {}, function () {

            }).complete(
                function () {
                    GetComments();
                    tinyMCE.get('CommentText').setContent("");
                    $.modal.close();
                });
        }
    }

    function ShowPanel(commentID) {
        if (commentID != "") {
            $('#CommentID').val(commentID);
            $('#CommentText').val($('#' + commentID).val());
            $('#AddC').hide();
            $('#UpdateC').show();
            $('#DeleteC').show();
        }
        else {
            $('#AddC').show();
            $('#UpdateC').hide();
            $('#DeleteC').hide();
        }
        $('#UserComment').modal();
        tinyMCE.init({
            mode: "exact",
            elements: "CommentText",
            theme: "advanced",
            plugins: "style,iespell,searchreplace,contextmenu,paste,html",

            //
            //  Theme options #1
            //
            theme_advanced_buttons1: "bold,italic,underline,forecolor,backcolor,|,formatselect,fontselect,fontsizeselect,|,cut,copy,paste,pastetext,pasteword,|,link,unlink,code",
            theme_advanced_buttons2: "justifyleft,justifycenter,justifyright,justifyfull,|,bullist,numlist,,,,,,,,,,,,,",
            theme_advanced_buttons3: "",
            theme_advanced_toolbar_location: "top",
            theme_advanced_toolbar_align: "left",
            theme_advanced_resizing: true,
            readonly: false
        });

        return false;
    }

    function GetComments() {
        $.ajax({
            cache: false,
            success: function (data) {
                var div = $("#UserCommentList");
                var trackHtml = "<table class width='100%' style='border-width: 0px;'>";
                for (var i = 0; i < data.length; i++) {
                    var date = new Date(parseInt(data[i].DateCreated.replace("/Date(", "").replace(")/", ""), 10));
                    var img = "https://microsoft.sharepoint.com/_layouts/15/userphoto.aspx?size=S&accountname=" + data[i].Alias + "%40microsoft.com&url=https%3A%2F%2Fmicrosoft-my.sharepoint.com%2FUser%20Photos%2FProfile%20Pictures%2F" + data[i].Alias + "_microsoft_com_SThumb.jpg";
                    trackHtml += "<tr bgcolor='#dddddd'>";
                    trackHtml += "<td valign='top' width='52' style='border-width: 0px;'><img src='" + img + "'/><BR/><B>" + data[i].Alias + "</B></td>";
                    trackHtml += "<td style='border-width: 0px;'><BR/><small>";
                    trackHtml += date.format("dd mmm yyyy hh:MMtt");;
                    trackHtml += "</small></td>";
                    trackHtml += "<td align='center' style='border-width: 0px;'><a href='javascript:void(0)' onclick='ShowPanel(" + data[i].Id + ")'>Edit</a><input type='hidden' id=" + data[i].Id + " value='" + data[i].CommentText + "' /></td>";
                    trackHtml += "</tr><tr><td valign='top' style='border-width: 0px;' colspan='3'>";
                    trackHtml += data[i].CommentText;
                    trackHtml += "</td></tr>";

                }
                trackHtml += "</table>";
                div.html(trackHtml);
            },
            url: "/FMS/GetComments/?transactionId=" + GlobalTransactionId
        });
    }
</script>
<h2>Comments</h2>
<span id="CommentPanel" style="width:100%;">
    <button id="btnShow" type="button" value="" onclick="ShowPanel('')" >Add Comment</button>
</span>

<span id="UserCommentList" style="width:100%;padding-top:20px;"></span>

<span id="UserComment" class="basic-modal">
    <textarea id="CommentText" name="CommentText" style="width:100%;height:600px;" >

	</textarea>
    <br />
    <span style="float:right">
        <input type="hidden" id="CommentID" value="" />
        <button id="AddC" style="margin:10px;" onclick="AddComment();">Save</button>
        <button id="UpdateC" style="margin:10px;" onclick="EditComment();">Update</button>
        <button id="DeleteC" style="margin:10px;" onclick="DeleteComment();">Delete</button>
    </span>
</span>